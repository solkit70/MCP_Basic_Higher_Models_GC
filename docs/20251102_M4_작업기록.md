# 2025-11-02 M4 진행 (스모크 테스트 중심)

목표
- FastAPI `/health`를 서버 기동 없이 스모크 테스트로 검증
- 실제 HTTP 호출 계획 수립(필요 시 실행)
- 다음 단계(M4 마무리 및 M5 준비) 체크리스트 정리

작업 요약
- 스크립트 실행: `04-app-integration/simple-webapp/scripts/run_health_smoke.ps1`
- 산출물: `docs/health_smoke_*.jsonl` (테스트 결과 1줄 JSON)
- 문제 발생 시: venv, 경로, 의존성(pydantic/uvicorn/httpx) 점검
 - 문서 추가: `04-app-integration/simple-webapp/README.md` (실행/테스트/트러블슈팅)

실행 로그
- 아래에 스모크 테스트 결과(JSON)를 추가합니다.
	- 2025-11-02T14:17:43Z 결과
		- 로그 파일: `docs/health_smoke_20251102_061742.jsonl`

```json
{"timestamp":"2025-11-02T14:17:43.478536Z","status_code":200,"ok":true,"json":{"status":"ok","version":"0.1.0","time":"2025-11-02T14:17:43.476514+00:00"}}
```

- 라이브 HTTP 체크 결과 (http://127.0.0.1:8000/health)
	- 응답 본문(JSON):

```json
{"status":"ok","version":"0.1.0","time":"2025-11-02T14:22:11.152406+00:00"}
```

품질 게이트(오늘)
- Build: PASS (의존성 설치 완료 기준)
- Lint/Typecheck: N/A (스모크 범위)
- Tests: PASS (스모크 스크립트 기준)

다음 단계
- 실제 HTTP로 `/health` 확인 (run_web.ps1 → Invoke-WebRequest)
- simple-webapp README 작성(실행/테스트/트러블슈팅)
- 선택: M5 준비(서비스 래퍼 설계 및 엔드포인트 계획)

## 학습 계획(검토 전용)

아래 내용은 오늘 실행 없이 읽고 이해하기 위한 학습 계획입니다. 실행은 추후 승인 후 진행합니다.

### 수행한 작업
- 리포 구조를 확인하여 앱, 스크립트, 문서, MCP 샘플의 위치를 재확인했습니다.
- M4(/health)와 MCP 샘플을 참고하기 위한 핵심 파일 존재 여부를 검증했습니다.
- 검토 가능한 학습 계획을 작성했습니다(실행 없음).

### 오늘 학습 계획: 무엇을 왜 읽는가
- 목표: Windows PowerShell 환경에서 M4(/health 200)를 마무리하는 길을 이해하고, 실행 시 어떤 산출물(로그/JSON)이 생성되는지 미리 파악합니다.
- 주의: 아래는 "읽기/이해" 단계이며, 아직 어떤 스크립트도 실행하지 않습니다.

1) 베이스라인 컨텍스트 파악
- 읽기:
	- `docs/20251019_M3_M4_작업기록.md` — 지난 세션의 상세 로그(무엇이 왜 동작했는지 배경 포함)
	- `docs/20251102_M4_작업기록.md` — 오늘 문서의 골격(목표/액션/로그 자리)
	- `README.md`(리포 루트) — 저장소 개요 및 탐색 가이드

2) FastAPI 앱의 /health 표면 이해
- 읽기:
	- `04-app-integration/simple-webapp/app/main.py` — FastAPI 앱 생성 및 라우터 include 확인
	- `04-app-integration/simple-webapp/app/routers/health.py` — /health 응답 형태(status/version/time)
	- `04-app-integration/simple-webapp/tests_smoke/health_smoke.py` — 서버 기동 없이 TestClient로 /health를 검증하는 방식
- 중점 관찰:
	- 응답 JSON 키와 HTTP 200 보장 경로
	- 테스트가 별도 서버 없이 인프로세스로 동작하는 점

3) 실행 방법(추후)과 생성 로그 미리 보기
- 읽기:
	- `04-app-integration/simple-webapp/scripts/run_health_smoke.ps1` — 스모크 테스트 원클릭 실행, JSONL 출력 경로 확인
	- `04-app-integration/simple-webapp/scripts/run_web.ps1` — uvicorn 기동 스크립트(CWD/PYTHONPATH, reload off)
- 중점 관찰:
	- 출력 파일 패턴 예: `docs/health_smoke_*.jsonl`
	- venv 활성화, 작업 디렉터리 가정 등 환경 처리

4) 환경/의존성 교차 확인
- 읽기:
	- `02-env-setup/requirements.txt` — 고정 버전(uvicorn, pydantic, httpx, mcp[cli])
	- `02-env-setup/scripts/setup.ps1`, `02-env-setup/scripts/activate.ps1` — 환경 구성 흐름과 활성화 방식
- 중점 관찰:
	- 이전 충돌을 해소한 버전 고정(예: uvicorn 0.31.1) 유지 여부
	- Windows 특성(실행 정책, 경로) 관련 메모

5) MCP 샘플로 실행/로깅 패턴 학습(오늘은 선택)
- 읽기:
	- `03-discover-servers/servers/fastmcp_quick_server.py` — 최소 FastMCP stdio 서버(ping/health)
	- `03-discover-servers/clients/python/mcp_quick_client.py` — 툴 목록 조회 및 health 호출
	- `03-discover-servers/scripts/run_mcp_quick_demo.ps1` — 실행/로그 캡처 패턴
	- `03-discover-servers/servers_catalog.md` — 카탈로그 개요
- 왜 보는가:
	- FastAPI 측에서도 동일한 “원클릭 실행 → 산출물 기록” 패턴을 적용할 수 있도록 레퍼런스 확보

6) 실행 후 문서화 포맷 미리 합의(오늘은 읽기만)
- 읽기:
	- `docs/20251102_M4_작업기록.md` — 아래 항목을 채울 준비:
		- 스모크 테스트 결과 JSON과 타임스탬프
		- 라이브 HTTP `/health` 응답과 uvicorn 기동 메모
		- 이슈/편차(있다면)
- 향후 캡처 목표:
	- “/health가 200과 예상 JSON을 반환”한다는 근거(응답 본문, 로그 파일 경로 포함)

### 빠르게 훑어볼 파일 인덱스
- 문서: `docs/20251019_M3_M4_작업기록.md`, `docs/20251102_M4_작업기록.md`
- 앱: `04-app-integration/simple-webapp/app/main.py`, `app/routers/health.py`, `tests_smoke/health_smoke.py`
- 스크립트: `scripts/run_health_smoke.ps1`, `scripts/run_web.ps1`
- 환경: `02-env-setup/requirements.txt`, `scripts/setup.ps1`, `scripts/activate.ps1`
- MCP 샘플(선택): `servers/fastmcp_quick_server.py`, `clients/python/mcp_quick_client.py`, `scripts/run_mcp_quick_demo.ps1`

### 승인 후 제가 진행할 일(실행 단계)
- 스모크 테스트와 라이브 HTTP 체크를 실행하고, 결과를 `docs/`에 저장한 뒤 본 문서에 JSON/로그 경로를 반영합니다.
- `04-app-integration/simple-webapp`에 README를 추가하고 Windows PowerShell 기준 트러블슈팅(포트 충돌, 실행 정책, 경로)을 정리합니다.

## 스모크 테스트 스크립트(run_health_smoke.ps1) 설명

### 목적
- FastAPI 서버를 띄우지 않고(`/uvicorn` 없이) 애플리케이션 내부에서 `/health` 엔드포인트를 스모크 테스트합니다.
- 테스트 결과를 한 줄 JSON으로 `docs/` 폴더에 기록하고, 성공/실패를 프로세스 종료 코드로 반환합니다.

### 주요 동작 흐름
1) 환경 활성화
	- `02-env-setup/scripts/activate.ps1`를 소스하여 가상환경(venv)을 활성화합니다.
	- `$ErrorActionPreference = 'Stop'`으로 오류 시 즉시 중단합니다.
2) 경로/로그 파일 준비
	- 스크립트 기준 앱 루트(`04-app-integration/simple-webapp`)로 이동 경로를 계산합니다.
	- 프로젝트 루트 `docs/`에 로그 파일 디렉터리를 보장하고, `health_smoke_YYYYMMDD_HHMMSS.jsonl` 파일명을 생성합니다.
3) 스모크 테스트 실행
	- 현재 위치를 앱 루트로 전환한 뒤 `python -u .\tests_smoke\health_smoke.py`를 실행합니다.
	- 표준 출력/에러를 통합 수집하고 마지막 한 줄(JSON)을 로그 파일에 저장합니다.
4) 성공/실패 판단 및 종료 코드
	- 마지막 JSON에서 `"ok": true`가 발견되면 `[OK]` 메시지와 함께 `exit 0` 반환, 아니면 `[FAIL]`과 `exit 1` 반환.
	- `finally` 블록에서 원래 위치로 복귀합니다.

### 테스트 코드가 하는 일(`tests_smoke/health_smoke.py`)
- FastAPI 앱(`app.main.app`)을 직접 import하고 `TestClient`로 `/health`를 호출합니다.
- 다음 형태의 한 줄 JSON을 출력합니다:
  - `timestamp`(UTC ISO, Z), `status_code`, `ok`(`status_code == 200`), `json`(응답 본문) 혹은 `raw_text`.

### 입력/전제조건
- 가상환경이 존재하고 의존성(FastAPI, Starlette TestClient, Pydantic 등)이 설치되어 있어야 합니다.
- 현재 리포의 디렉터리 구조(앱/테스트 경로)가 유지되어야 합니다.
- Windows PowerShell 5.1 기준 스크립트 문법을 사용합니다.

### 출력/산출물
- 파일: `docs/health_smoke_YYYYMMDD_HHMMSS.jsonl`
- 내용: 정확히 한 줄 JSON(예: `{ "timestamp": "...Z", "status_code": 200, "ok": true, "json": { ... } }`).
- 콘솔: 실행 경로, 저장 경로, OK/FAIL 메시지.

### 성공 기준과 실패 시나리오
- 성공: `/health`가 200 → `ok: true`, 종료 코드 0.
- 실패: 200 미만/초과, import/의존성 오류, 경로 문제 등 → `ok: false` 또는 예외, 종료 코드 1.

### 언제/왜 사용하는가
- 라이브 서버 없이 라우팅/핸들러/의존성 문제를 신속히 확인합니다.
- CI에서도 빠른 피드백과 JSON 산출물 기록에 적합합니다.
- 포트/방화벽/uvicorn 설정 이슈와 분리해 앱 로직을 먼저 검증합니다.

### 선택: 실행(문서용 예시)
```powershell
.\04-app-integration\simple-webapp\scripts\run_health_smoke.ps1
```
실행 후 `docs\health_smoke_*.jsonl` 생성 여부와 `ok: true`를 확인하세요.
