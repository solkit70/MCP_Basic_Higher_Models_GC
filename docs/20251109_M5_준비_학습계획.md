# 2025-11-09 M5 준비 학습계획 (Reading Only)

본 문서는 실행/코딩 없이 오늘 학습할 내용을 정리한 WorkLog입니다. 목적은 M5(웹앱에 기존 MCP 서버 통합)를 준비하기 위한 개념·요구사항·설계 포인트를 명확히 이해하는 것입니다.

## 1) 오늘 목표
- FastAPI 앱 구조 재확인 (app/main.py, app/routers/health.py)
- MCP 통합 시 필요한 클라이언트 래퍼 요구사항(타임아웃/리트라이/입출력 검증/에러 모델) 이해
- 예정 엔드포인트(`/mcp/tools`, `/mcp/actions/<tool>`, `/mcp/health`)의 흐름/응답 스키마 상상
- .env 핵심 키(`MCP_SERVER_URI`, `MCP_EXEC_PATH` 등) 식별
- 계약 테스트(정상/에러/타임아웃/스키마 불일치/취소) 범위 파악

## 2) 참고 산출물 맵
- 로드맵: `GC_version/GC_docs/250921_roadmap_githubcopilot.md` (M5 요구사항)
- 프롬프트: `prompts/prompt_YYYYMMDD.txt` 시리즈
- Work Logs: `docs/20250921_초기_세팅_및_업로드.md`, `docs/20251005_M1_작업기록.md`, `docs/20251012_M2_작업기록.md`, `docs/20251102_M4_작업기록.md`
- 앱: `04-app-integration/simple-webapp/app/...`
- 스크립트: `04-app-integration/simple-webapp/scripts/run_health_smoke.ps1`, `run_web.ps1`
- 환경: `02-env-setup/scripts/setup.ps1`, `activate.ps1`

## 3) 오늘 읽기 순서
1. 로드맵 M5 부분 재독 → 요구 기능/DoD/체크리스트 정리
2. 최근 WorkLog(M4) → 다음 단계 자연스러운 연계 포인트 확인
3. 앱 구조 파일 훑기 → 서비스 계층(`app/services/`) 삽입 위치 상상
4. 프롬프트 템플릿(`prompts/prompt_template.txt`) → 다음 세션 작성 방식 이미지
5. `requirements.txt` → 추가 패키지 후보(httpx, websockets, backoff) 목록만 확인

## 4) MCP 클라이언트 래퍼 설계 포인트(개념 초안)
- 입력: tool 이름, params(dict), 옵션(timeout, retries)
- 출력: { data, meta } 또는 { error: { code, message, kind } }
- 기능: transport 추상화(stdio/WS), 타임아웃, 리트라이/백오프, pydantic 검증, 최소 로깅(latency)
- 구조(예): `app/services/mcp_client.py` + adapters(`StdIoAdapter`, `WsAdapter`)

## 5) 예정 API 엔드포인트 상상
- GET `/mcp/tools` → list_tools() 결과
- POST `/mcp/actions/<tool>` → body: params {}; resp: { data, latency_ms, tool, success }
- GET `/mcp/health` → ping/metadata (status, server_type, latency)
- 상태코드/에러 JSON 통일: 200/4xx/5xx 규칙, ValidationError → 표준 에러 변환

## 6) 계약 테스트 범주
1) 정상 호출  2) 파라미터 오류(422/400)  3) 타임아웃  4) 연결 실패  5) 스키마 불일치  6) (선택) 취소

## 7) 트러블슈팅 사전 인지
| 영역 | 대표 증상 | 대비 |
|------|-----------|------|
| stdio 실행 | 경로/권한 오류 | 경로 존재/권한 체크 |
| WebSocket | 타임아웃/DNS 실패 | URI 파싱/사전 확인 |
| 응답 스키마 | 키 누락/타입 오류 | pydantic ValidationError → 표준 에러 |
| 성능 | 지연 | latency 측정/평균 |
| 리트라이 | 과도 반복 | 최대 횟수/백오프 상한 |
| 환경변수 | 누락 | 필수키 검증 후 즉시 오류 |

## 8) 패키지/구성 체크(설치 아님)
- 후보: httpx, websockets, pydantic(기존), (선택) backoff/tenacity
- .env 키 후보: MCP_MODE, MCP_EXEC_PATH, MCP_SERVER_URI, MCP_TIMEOUT_DEFAULT, MCP_RETRY_MAX

## 9) 오늘 산출물 (문서만)
- 본 파일: `docs/20251109_M5_준비_학습계획.md`

### [추가] 구현 착수 기록 (스켈레톤 생성 완료)
다음 파일을 추가/수정하여 M5 기본 골격을 마련했습니다 (mock 모드 기반):
- `app/services/mcp_client.py` — MCP 클라이언트 래퍼 (mock adapter / echo, sum tool)
- `app/routers/mcp.py` — `/mcp/tools`, `/mcp/actions/{tool}`, `/mcp/health` 엔드포인트
- `app/main.py` — 새 라우터 include
- `tests_mcp/test_mcp_endpoints.py` — 기본 동작/검증/에러 케이스 테스트

기능 요약:
- Tools: echo(원본 파라미터 반환), sum(숫자 리스트 합계)
- 오류 모델: `McpClientError(code, message, detail)` → HTTP 400/404/503 변환
- health: mock 서버 상태 `{status: ok, server_type: mock}`
- latency_ms 측정 후 응답 포함

다음 보강 예정 포인트:
- stdio/ws adapter 실제 구현 및 환경변수 전환 테스트
- 리트라이/백오프 로직 삽입(네트워크 오류 한정)
- pydantic 모델 분리 및 스키마 확장(tool별 strict schema)
- .env 구성 예시 문서화 (.env.example 업데이트)
 - VS Code 외부 MCP 서버 연결 가이드 초안 추가됨 → `docs/20251109_VSCode_MCP_연결_가이드.md`

### [추가] 외부 MCP 서버 선택 및 실행 계획 (echo.py)
선택 대상: 공식 Python SDK 예제 `modelcontextprotocol/python-sdk` 의 `examples/fastmcp/echo.py` (Echo Server)
- 참고 링크: https://github.com/modelcontextprotocol/python-sdk/blob/main/examples/fastmcp/echo.py
- 이유: 코드가 매우 작고(수십 줄), tools/resource/prompt 개념이 한 파일에 투명하게 드러남. 불필요한 의존성 없이 MCP 기본 흐름 학습에 최적.

실행/학습 절차 (요약):
1) 로컬 Python venv 활성화 후 SDK 설치
	- pip install modelcontextprotocol
2) echo.py 내용을 로컬에 저장 후 실행 (stdio 모드)
	- python echo.py (stdin/stdout 기반 MCP 서버 구동)
3) 독립 검증
	- initialize, list_tools, echo_tool 호출을 수동/도구(MCP Inspector 등)로 확인
4) 우리 앱과의 연동 (다음 작업 필요)
	- stdio adapter 구현(필수): `app/services/mcp_client.py` 내 stdio 경로의 `_NotImplementedAdapter("stdio")` 대체
	- .env 설정: `MCP_MODE=stdio`, `MCP_EXEC_PATH="<python.exe> <echo.py 경로>"`
	- 웹앱 구동 후 `/mcp/tools`, `/mcp/actions/echo` 호출 비교(mock vs stdio)

주의/메모:
- 라이선스/출처 표기 유지, 경로에 공백 있는 경우 PowerShell 인용부호 주의
- stdio adapter가 준비되기 전까지는 독립 실행/검증 단계에서 먼저 MCP 프레임을 관찰


## 10) 체크리스트 (이해 완료)
- [ ] M5 핵심 목표 설명 가능
- [ ] 서비스/엔드포인트 파일 경로 기억
- [ ] 트러블슈팅 3가지 이상 설명 가능
- [ ] 3개 엔드포인트 목적 명확
- [ ] 타임아웃/리트라이 기본값 가정 가능
- [ ] ValidationError → 에러 JSON 변환 이해
- [ ] .env 필수 키 집합 파악
 - [ ] mock 외 transport(adapter) 구현 계획 정리

## 11) 리스크 & 대비
| 리스크 | 영향 | 대비 |
|--------|------|------|
| SDK 명칭/사용법 변동 | 구현 지연 | [검증] 후 업데이트 |
| WS 세션 관리 복잡 | 리소스 누수 | 컨텍스트/재연결 전략 |
| 스키마 변동 | 실패 증가 | 버전 필드/캐시 무효화 |
| 과도 재시도 | 서버 부담 | 네트워크 오류만 재시도 |

## 12) 다음 세션(실행 예정)
- 문서 보완 + `app/services/mcp_client.py` 스캐폴딩
- `app/routers/mcp.py` 초안
- 테스트 더블/프로필로 최소 호출 E2E 준비

### [다음 세션 시작 작업 우선순위]
1) M5 스켈레톤 커밋/푸시 (현재 미완료) → 저장소 동기화
2) stdio adapter 구현 착수
	- 목표: echo.py 서버 기동 후 `/mcp/tools` 및 `/mcp/actions/echo`가 mock과 동일 계약으로 동작
	- 구현 스텝: Popen(spawn) → readline 루프 → JSON-RPC frame 송수신 → 오류/타임아웃 변환
3) echo.py 독립 실행 및 초기 프레임 캡처 (initialize, list_tools, tool 호출 2회, 에러 1회)
	- 결과 JSON을 새 WorkLog(2025-11-XX) 파일에 기록
4) .env 실제 생성(.env.example 기반) → MCP_MODE=stdio / MCP_EXEC_PATH 설정
5) 통합 테스트 초안 추가: `tests_integration/test_mcp_stdio.py`
	- 조건: 외부 echo 서버 실행 중일 때만 동작하거나 skip 메커니즘(환경변수) 적용
6) 체크리스트 갱신: M5 핵심 목표/트러블슈팅/transport 구현 항목 완료 상태 반영
7) 필요 시 WebSocket adapter 설계 초안 문서화(코드 구현은 다음 회차)

> 최소 완료 기준: (1) 커밋/푸시, (2) stdio adapter 통해 echo 호출 성공, (3) WorkLog에 raw request/response 기록.

## 13) 오늘은 하지 않는 것
- 코드 생성/수정, 스크립트 실행, 패키지 설치, 커밋/푸시

---
출처 참고: `GC_version/GC_docs/250921_roadmap_githubcopilot.md` M5 섹션 및 기존 WorkLogs/프롬프트