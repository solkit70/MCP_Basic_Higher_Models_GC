# 2025-10-19 M3 진행 + M4 예고

목표
- WS echo 데모를 원클릭으로 실행하고 결과를 기록
- 다음 세션에서 M4(FastAPI 스켈레톤)로 자연스럽게 이어지도록 준비

수행 내용
- ws_client.py 개선: 메시지 송신/수신 검증, 타임아웃 옵션 추가
- run_echo_demo.ps1 추가: 로컬 echo 서버 기동 → 클라이언트로 echo 확인 → 로그 저장

실행 방법(PS 5.1)
- `03-discover-servers/scripts/run_echo_demo.ps1`
  - logs/echo_server_*.txt, echo_client_*.txt 생성

기대 결과
- client 로그에 [OK] Connected, [SEND] <msg>, [RECV] <msg>, [OK] Echo matched가 표시

다음 세션 예고(M4)
- `04-app-integration/simple-webapp` 스캐폴딩(FastAPI)
- `/health` 엔드포인트, 설정 로딩, 구조화 로깅
- 이후 M5에서 MCP 클라이언트 연동

---

## M4 시작 전 준비 체크리스트 (요약)
- Python venv 활성화 가능 여부 확인(.venv)
- 포트 사용 가능 여부 확인(기본 8000)
- Windows PowerShell 5.1에서 uvicorn 실행 가능하도록 의존성 설치 계획 수립

## M4 상세 학습 계획 (Step by Step)
1) 의존성 확정 및 설치 스크립트 준비 (10분)
  - 패키지: fastapi, uvicorn[standard], pydantic, python-dotenv, httpx(추후 헬스체크/연동 테스트용)
  - 방법: `02-env-setup/requirements.txt`에 반영 후 `pip install -r`로 일괄 설치 또는 전용 `scripts/install_webapp.ps1` 제공
  - 산출물: 설치 로그(요약), 실패 시 트러블슈팅 메모(방화벽/SSL/프록시 등)

2) 프로젝트 스캐폴딩 생성 (20분)
  - 경로: `04-app-integration/simple-webapp/`
  - 구조:
    - `app/main.py` (FastAPI 앱 팩토리/라우팅 등록)
    - `app/routers/health.py` (`/health` 200, 버전/시간 반환)
    - `app/services/__init__.py` (추후 MCP 클라이언트 래퍼 위치 안내)
    - `config/.env.example` (`APP_ENV`, `PORT`, `LOG_LEVEL` 등)
    - `scripts/run_web.ps1` (uvicorn 실행)
    - `README.md` (실행/테스트/트러블슈팅)
  - 산출물: 초기 파일 세트, 코드 주석으로 학습 포인트 명시

3) 설정 로딩과 구조화 로깅 (15분)
  - `python-dotenv`로 `.env` 로딩, 기본값과 타입 검증(pydantic BaseSettings 또는 수동 검증)
  - 로깅: uvicorn 로거 레벨, 요청/응답 로깅 최소화(PII 주의), JSON 포맷 예시는 선택
  - 산출물: `.env.example`, 설정 모듈/주석, 로그 샘플

4) /health 엔드포인트 구현 및 자체 테스트 (15분)
  - 응답 스키마: `{ "status": "ok", "version": "0.1.0", "time": ISO8601 }`
  - 자체 테스트: `httpx`로 로컬 호출 스크립트 또는 간단한 pytest 테스트(선택)
  - 산출물: 엔드포인트 코드, 수동/자동 테스트 로그

5) 실행 스크립트와 원클릭 실행 흐름 정리 (10분)
  - `scripts/run_web.ps1`: venv 활성화 → uvicorn app.main:app --reload --port $PORT
  - 포트 충돌 시 자동 대체 또는 오류 메시지 개선
  - 산출물: 실행 성공 스크린샷/로그 경로, README에 복붙 가능한 명령

6) 문서화 및 학습 포인트 정리 (10분)
  - README에 구조/레이어(routers/services/config) 설명, 추후 M5 연동 지점 표시
  - 트러블슈팅: 포트/방화벽, 인코딩, PowerShell 실행 정책, .env 로딩 실패 등
  - 산출물: README 갱신, 본 작업기록에 요약 추가

7) 다음 단계 예고(M5와의 연결) (5분)
  - 서비스 계층에 `mcp_client.py` 추가 예정(타임아웃/재시도/스키마 검증 포함)
  - `.env`에 `MCP_SERVER_URI` / `MCP_EXEC_PATH` 등 설정 확장
  - `/mcp/actions/<tool>` 라우트 초안 및 계약 테스트 계획 수립

## 완료 기준(DoD)
- uvicorn으로 로컬 실행 성공(`/health` 200)
- `.env`로 포트/로그 레벨 등 설정 주입 가능, 기본값 정상 동작
- README에 실행/테스트/트러블슈팅이 명확히 정리됨
- 이후 M5에서 바로 MCP 통합을 시작할 수 있을 정도로 구조가 준비됨

## 트러블슈팅 체크리스트
- 모듈 미설치: 가상환경 활성화 후 `pip list`로 확인, 필요시 재설치
- 포트 충돌: 8000 사용 중이라면 8001 등으로 변경(`.env` 또는 run 스크립트 인자)
- Windows 경로/인코딩: UTF-8 저장, 콘솔 글꼴/코드페이지 영향 주의
- ExecutionPolicy: 프로세스 범위 우회(Set-ExecutionPolicy …)로 스크립트 실행 보장

---

# 2025-10-19 추가 작업 기록 (M3 마무리 + M4 진행)

요약
- M3(2) "공식 SDK 설치 + 툴 목록/헬스 호출 샘플" 과제를 완료했습니다.
- 공식 SDK를 사용한 최소 MCP 서버/클라이언트/원클릭 실행 스크립트를 추가했고, 실행 결과(JSON 로그)로 검증했습니다.
- M4를 위한 Simple Web App 스켈레톤(FastAPI) 파일들을 추가하고, `/health`를 코드 레벨에서 점검할 수 있는 스모크 테스트를 마련했습니다.

## 변경/추가된 의존성
- 02-env-setup/requirements.txt 정합성 조정
  - mcp[cli]==1.18.0 (공식 SDK)
  - uvicorn[standard]==0.31.1 (SDK 요구사항 충족)
  - pydantic==2.11.4 (SDK 요구사항 충족)
  - httpx==0.28.1 (호환성 기준 상향)
- 별도 PyPI의 fastmcp 패키지는 버전 충돌로 제외하고, 공식 SDK 내 FastMCP 모듈을 사용

## 생성한 파일 (주요 목적)
- 03-discover-servers/servers/fastmcp_quick_server.py
  - 공식 SDK의 FastMCP로 구현한 최소 stdio 서버
  - 툴: `ping() -> "pong"`, `health() -> {"status":"ok"}`
- 03-discover-servers/clients/python/mcp_quick_client.py
  - 공식 SDK ClientSession + stdio_client 사용
  - 서버를 stdio로 스폰 → 초기화 → 툴 목록 조회 → health 툴 호출 → JSON 한 줄 출력
- 03-discover-servers/scripts/run_mcp_quick_demo.ps1
  - 원클릭 데모: venv 활성화 → 클라이언트 실행 → stdout/stderr 각각 로그 저장 → 종료 코드 반영
  - Windows PowerShell 환경에서 stderr를 에러로 오인하지 않도록 ProcessStartInfo 기반 캡처로 보강
- 04-app-integration/simple-webapp/app/
  - __init__.py, main.py (FastAPI 앱), routers/health.py (`/health` 구현)
- 04-app-integration/simple-webapp/tests_smoke/health_smoke.py
  - FastAPI 앱을 직접 import하여 TestClient로 `/health`를 점검하는 스모크 테스트
- 04-app-integration/simple-webapp/scripts/run_health_smoke.ps1
  - 위 스모크 테스트 실행 및 JSONL 로그 저장 스크립트
- 04-app-integration/simple-webapp/scripts/run_web.ps1
  - uvicorn 기동 스크립트(CWD/PYTHONPATH 정리, .env 옵션 처리)

## 실제 실행 및 결과 (증빙 로그)
1) 공식 SDK 데모 실행
   - 명령: `03-discover-servers/scripts/run_mcp_quick_demo.ps1`
   - 생성 로그(예):
     - stdout(JSONL): `03-discover-servers/logs/mcp_quick_stdout_20251019_073441.jsonl`
     - stderr: `03-discover-servers/logs/mcp_quick_stderr_20251019_073441.log`
   - stdout JSON 내용 예시:
     ```jsonl
     {"tools": ["ping", "health"], "health": {"status": "ok"}}
     ```
   - 판단: "툴 목록 조회 + health 호출"이 정상적으로 수행되어 M3(2) DoD 충족

2) FastAPI 스모크 테스트(사전 배치)
   - 명령: `04-app-integration/simple-webapp/scripts/run_health_smoke.ps1`
   - 역할: uvicorn을 띄우지 않고도 앱 import + TestClient로 `/health` 응답을 로컬에서 즉시 검증
   - 현재 상태: 스크립트와 테스트 코드는 추가됨. 실행은 다음 세션에서 기록 예정.

## 문제/해결 메모
- PowerShell에서 `2>` 표준 오류 리다이렉트가 스크립트 실패로 해석되는 이슈 → `ProcessStartInfo` 기반으로 stdout/stderr를 캡처하고 종료 코드를 명시적으로 반영하도록 개선
- Python 실행 파일 경로 판별 문제(환경 변수 불안정) → venv의 python.exe 우선, 없으면 `$env:PYTHONEXECUTABLE` → 최종적으로 `python` 순서로 폴백
- uvicorn 리로더 하위 프로세스에서 import path 문제가 발생할 수 있어, 초기에는 `--reload` 없이 동작하도록 run 스크립트를 구성

## 오늘의 산출물 요약
- M3(2): 공식 SDK 기반 최소 서버/클라이언트/원클릭 스크립트 + 성공 로그(JSONL)
- M4 준비: FastAPI 스켈레톤, `/health` 라우터, 스모크 테스트/실행 스크립트 배치

## 다음 세션 계획 (M4 마무리)
1) 스모크 테스트로 `/health` 200 확인 로그 적재
2) uvicorn 기동(run_web.ps1) 및 실제 HTTP 호출 기록(httpx 또는 브라우저)
3) simple-webapp용 간단 README(실행/테스트/트러블슈팅) 추가
4) 필요 시 포트 충돌/경로 이슈에 대한 보완(자동 포트 조정 또는 오류 메시지 개선)

## 부록: 참고 명령 (Windows PowerShell)
- venv 활성화 및 패키지 설치:
  - `02-env-setup/scripts/activate.ps1`; `pip install -r 02-env-setup/requirements.txt`
- WS Echo 데모:
  - `03-discover-servers/scripts/run_echo_demo.ps1`
- MCP SDK 데모(공식 SDK):
  - `03-discover-servers/scripts/run_mcp_quick_demo.ps1`
- WebApp 헬스 스모크:
  - `04-app-integration/simple-webapp/scripts/run_health_smoke.ps1`
